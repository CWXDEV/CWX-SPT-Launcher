@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Class="py-4 card-overflow">
            <MudContainer Class="d-flex flex-column align-center gap-4">
                @if (Tasks <= ELoginTaskResults.Types)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large"/>
                }
                else if (Tasks == ELoginTaskResults.Success)
                {
                }
                else if (Tasks == ELoginTaskResults.Failed)
                {
                }
                else if (Tasks == ELoginTaskResults.Aborted)
                {
                }
                <MudText>@TaskText</MudText>
            </MudContainer>
            <MudContainer Class="mt-3 d-flex justify-end pa-0 gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Error" Class="ml-auto" @onclick="() => Cancel()">Cancel</MudButton>
            </MudContainer>
        </MudContainer>
    </DialogContent>
</MudDialog>

@code {
    private ServerHelper serverHelper = ServerHelper.Instance;
    private ELoginTaskResults Tasks = ELoginTaskResults.NotStarted;
    private string TaskText = "";
    [Parameter] public ServersClass Server { get; set; }
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _ = StartLoginTasks();
    }

    // look into Task cancellations
    // and actually wire this up
    private async Task StartLoginTasks()
    {
        Tasks = ELoginTaskResults.Started;
        TaskText = "Starting login tasks";
        
        // test connection
        Tasks = ELoginTaskResults.Connection;
        TaskText = "Checking connection to server";
        await Task.Delay(20); // artificial to hopefully fix "focus on invalid element"
        var reach = await serverHelper.IsServerReachable(Server);
        if (!reach)
        {
            // failed
            Console.WriteLine("SOMETHING FUCKED UP PINGING SERVER");
            return;
        }
        // passed
        
        // get profile data
        Tasks = ELoginTaskResults.Profiles;
        TaskText = "Getting profiles from server";
        StateHasChanged();
        var profiles = await serverHelper.GetServerProfiles(Server);
        if (!profiles)
        {
            // failed
            Console.WriteLine("SOMETHING FUCKED UP GETTING PROFILES");
            return;
        }
        // passed
        
        // get Creation data
        Tasks = ELoginTaskResults.Types;
        TaskText = "Getting profile creation data";
        StateHasChanged();
        var types = await serverHelper.GetCreationTypes(Server);
        if (!types)
        {
            Console.WriteLine("SOMETHING FUCKED UP GETTING CREATION DATA");
            return;
        }
        // passed
        
        Tasks = ELoginTaskResults.Success;
        TaskText = "Check the Profiles in the NavMenu!";
        StateHasChanged();
        Submit();
    }
    
    private void Submit()
    {
        MudDialog.Close(DialogResult.Ok(Server));
        Snackbar.Add("Logged In. Visit Profiles Page!", Severity.Success);
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}